<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Using Image Builder in the stage environment - Image Builder in cloud.redhat.com guide</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="image-builder-in-stage.html" class="active"><strong aria-hidden="true">1.</strong> Using Image Builder in the stage environment</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Image Builder in cloud.redhat.com guide</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#using-image-builder-in-staging-environment-from-command-line" id="using-image-builder-in-staging-environment-from-command-line">Using Image Builder in staging environment from command line</a></h1>
<p>Image Builder is an instance of an upstream image-builder project. You can find the code and report issues here: https://github.com/osbuild/image-builder . It provides a REST API, which is accessible using the squid.corp.redhat.com HTTP proxy server.</p>
<p>All you need to access the service is the “curl” tool which is available on any operating system. You will also need to know your Red Hat username and password (which one?)</p>
<p><em>(TODO: How is it possible that it did not exist for Tom and why does he have such a funny username?).</em></p>
<p>To display the available API endpoints and all the JSON objects you can use invoke this command:</p>
<pre><code>curl --user &quot;username@redhat.com:password&quot; \
        --proxy http://squid.corp.redhat.com:3128 \
        https://cloud.stage.redhat.com/api/image-builder/v1/openapi.json
</code></pre>
<p>The command contains:</p>
<ul>
<li>Your credentials after the <code>--user</code> CLI flag</li>
<li>URL of the HTTP proxy server after the <code>--proxy</code> flag</li>
<li>URL of the staging instance of image builder</li>
</ul>
<p><em>Tip: If you want nice formatting of the JSON object, use the “jq” tool):</em></p>
<pre><code>curl --user &quot;username@redhat.com:password&quot; \
        --proxy http://squid.corp.redhat.com:3128 \
        https://cloud.stage.redhat.com/api/image-builder/v1/openapi.json | jq .
</code></pre>
<p>There are two main API endpoints related to starting and monitoring a compose:</p>
<ol>
<li>HTTP POST /v1/compose</li>
<li>HTTP GET /v1/composes/<uuid></li>
</ol>
<p>If you want to start a new compose, you need to create a JSON file containing a description of the image you want. For example:</p>
<pre><code class="language-json">{
  &quot;distribution&quot;: &quot;rhel-8&quot;,
  &quot;image_requests&quot;: [
    {
      &quot;architecture&quot;: &quot;x86_64&quot;,
      &quot;image_type&quot;: &quot;ami&quot;,
      &quot;upload_requests&quot;: [
        {
          &quot;type&quot;: &quot;aws&quot;,
          &quot;options&quot;: {
            &quot;share_with_accounts&quot;: [
              &quot;your-aws-account-id&quot;
            ]
          }
        }
      ]
    }
  ]
}
</code></pre>
<p>Save the file as “image-builder-request.json”.</p>
<p>Given the JSON file above, Image Builder will create a RHEL 8 AMI image for x86_64 architecture and upload it to AWC EC2. It will then share the AMI with the specified account.</p>
<p>Now trigger a new compose:</p>
<pre><code>curl --user &quot;username@redhat.com:password&quot; \
        --proxy http://squid.corp.redhat.com:3128 \
        -d &quot;@image-builder-request.json&quot; -X POST \
        -H &quot;Content-Type: application/json&quot; \
        https://cloud.stage.redhat.com/api/image-builder/v1/compose
{&quot;id&quot;:&quot;cb13b6e6-d24e-4417-a4f4-547f410609e1&quot;}
</code></pre>
<p>The command specifies:</p>
<ul>
<li>JSON body of the message (-d)</li>
<li>HTTP POST method (-X)</li>
<li>HTTP header “Content-Type” (-H)</li>
<li>The output contains id of the newly created compose which you can use to monitor it:</li>
</ul>
<pre><code>curl --user &quot;username@redhat.com:password&quot; \
        --proxy http://squid.corp.redhat.com:3128 \
        -H &quot;Content-Type: application/json&quot; \
        https://cloud.stage.redhat.com/api/image-builder/v1/composes/cb13b6e6-d24e-4417-a4f4-547f410609e1
{&quot;status&quot;:&quot;running&quot;}
</code></pre>
<p>Once the status is “success”, you can go to your AWS account and check the list of available AMIs.</p>
<p><em>(TODO: we need a way to identify the AMI)</em></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
